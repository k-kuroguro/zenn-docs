---
title: "Wasm ã‚’æ‰±ã† Custom Hooks ã‚’æ›¸ã"
emoji: "ğŸª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["deno", "typescript", "react", "reacthooks", "wasm"]
published: true
---

# æ¦‚è¦

React ã§ Wasm ã‚’æ‰±ã†ç°¡å˜ãª Custom Hooks ã‚’æ›¸ã. ãªãŠ, Wasm ã¯ Rust ã‚³ãƒ¼ãƒ‰ã‚’ [wasmbuild](https://github.com/denoland/wasmbuild) ã§ãƒ“ãƒ«ãƒ‰ã—ãŸã‚‚ã®ã‚’ä½¿ç”¨ã™ã‚‹.

# ç’°å¢ƒ

- React 18.1.0
- Deno 1.38.5
- wasmbuild 0.15.4
- rustc 1.70.0

# Custom Hooks ã®æ¦‚è¦

wasmbuild ã¯ `<crate-name>_bg.wasm` ã¨ãã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã§ã‚ã‚‹ `<crate-name>.generated.js` ã‚’ç”Ÿæˆã™ã‚‹. ã‚¯ãƒ¬ãƒ¼ãƒˆåãŒ `wasm` ã®ã¨ã, ã“ã‚Œã‚‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ä½¿ç”¨ã§ãã‚‹.

```ts
import { instantiate } from 'wasm.generated.js';

const exports = await instantiate({
  url: new URL('wasm_bg.wasm', location.origin),
});
const { add } = exports;

console.log(add(1, 2)); // 3
```

ã“ã®å‡¦ç†ã‚’ Context ã§éš è”½ã—, Custom Hooks ã¨ã—ã¦ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹.

# Custom Hooks ã®å®Ÿè£…

Context Provider ã¨ã—ã¦ `WasmProvider` ã‚’, Custom Hooks ã¨ã—ã¦ `useWasm` ã‚’å®Ÿè£…ã™ã‚‹. Context ã®å‹ã¯, wasm ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿çŠ¶æ³ã¨ãã®çŠ¶æ³ã«å¿œã˜ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ã‚’æŒã¤ `WasmState` ã¨ã™ã‚‹. ã¾ãŸ, `WasmProvider` ã¯ `src` ã¨ã—ã¦ wasm ãƒ•ã‚¡ã‚¤ãƒ«ã® URL ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã™ã‚‹.

```tsx
import { instantiate } from 'wasm.generated.js';

const WasmLoadState = {
   Ready: 'ready',
   Loading: 'loading',
   Error: 'error',
} as const;
type WasmLoadState = (typeof WasmLoadState)[keyof typeof WasmLoadState];
type WasmExports = Awaited<ReturnType<typeof instantiate>>;
type WasmState = {
   loadState: typeof WasmLoadState.Loading;
} | {
   loadState: typeof WasmLoadState.Error;
   error: Error;
} | {
   loadState: typeof WasmLoadState.Ready;
   exports: WasmExports;
};
type WasmProviderProps = {
   src: string;
   children: ReactNode;
};

const WasmProvider: FC<WasmProviderProps> = ({ src, children }) => {
   ...
};
```

`instantiate` ãŒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™éåŒæœŸé–¢æ•°ã§ã‚ã‚‹ãŸã‚, ä¸Šè¨˜ã®ã‚ˆã†ã« `Awaited` ã¨ `ReturnType` ã§ `WasmExports` ã‚’å®šç¾©ã§ãã‚‹.

`WasmProvider` ã¯ `instantiate` ã®çŠ¶æ³ã«åˆã‚ã›ã¦ `WasmState` ã‚’æ›´æ–°ã—, ãã‚Œã‚’ `WasmContext` ã«æ¸¡ã›ã°ã‚ˆã„ã®ã§, ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã§ãã‚‹.

```tsx
const initialWasmState: WasmState = {
   loadState: WasmLoadState.Loading,
};
const WasmContext = createContext<WasmState>(initialWasmState);

const WasmProvider: FC<WasmProviderProps> = ({ src, children }) => {
   const [wasmState, setWasmState] = useState<WasmState>(initialWasmState);

   useEffect(() => {
      (async () => {
         try {
            const exports = await instantiate({
               url: new URL(src),
            });
            setWasmState({
               loadState: WasmLoadState.Ready,
               exports,
            });
         } catch (e) {
            setWasmState({
               loadState: WasmLoadState.Error,
               error: e,
            });
         }
      })();
   }, [src]);

   return (
      <WasmContext.Provider value={wasmState}>
         {children}
      </WasmContext.Provider>
   );
};
```

`useWasm` ã¯ `WasmContext` ã‚’ä½¿ç”¨ã—ã¦ `WasmState` ã‚’å–å¾—ã™ã‚‹ã ã‘ã§ã‚ã‚‹.

```tsx
const useWasm = () => useContext(WasmContext);
```

å…¨ã¦ã®å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹. (é•·ã„ã®ã§ç•³ã‚“ã§ãŠã)

:::details useWasm.tsx
```tsx
import React, {
   createContext,
   FC,
   ReactNode,
   useContext,
   useEffect,
   useState,
} from 'react';
import { instantiate } from 'wasm';

const WasmLoadState = {
   Ready: 'ready',
   Loading: 'loading',
   Error: 'error',
} as const;
type WasmLoadState = (typeof WasmLoadState)[keyof typeof WasmLoadState];
type WasmProviderProps = {
   src: string;
   children: ReactNode;
};
type WasmExports = Awaited<ReturnType<typeof instantiate>>;
type WasmState = {
   loadState: typeof WasmLoadState.Loading;
} | {
   loadState: typeof WasmLoadState.Error;
   error: Error;
} | {
   loadState: typeof WasmLoadState.Ready;
   exports: WasmExports;
};

const initialWasmState: WasmState = {
   loadState: WasmLoadState.Loading,
};
const WasmContext = createContext<WasmState>(initialWasmState);

const WasmProvider: FC<WasmProviderProps> = ({ src, children }) => {
   const [wasmState, setWasmState] = useState<WasmState>(initialWasmState);

   useEffect(() => {
      (async () => {
         try {
            const exports = await instantiate({
               url: new URL(src),
            });
            setWasmState({
               loadState: WasmLoadState.Ready,
               exports,
            });
         } catch (e) {
            setWasmState({
               loadState: WasmLoadState.Error,
               error: e,
            });
         }
      })();
   }, [src]);

   return (
      <WasmContext.Provider value={wasmState}>
         {children}
      </WasmContext.Provider>
   );
};

const useWasm = () => useContext(WasmContext);

export { WasmLoadState, WasmProvider };
export default useWasm;
```
:::

ä¸Šè¨˜ã®å®Ÿè£…ã®ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦

- Context ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚, è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã£ã¦ Wasm ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã§ã‚‚ä¸€åº¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã§æ¸ˆã‚€.
- wasmbuild ã®ã‚°ãƒ«ãƒ¼ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å‹ä»˜ã‘ã®æ©æµã‚’å—ã‘ã‚‰ã‚Œã‚‹.

ã“ã¨ãŒæŒ™ã’ã‚‰ã‚Œã‚‹.


# ä½¿ç”¨ä¾‹

ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ä½¿ã†.

```tsx: App.tsx
import React from 'react';
import ComponentWithWasm from './ComponentWithWasm';
import { WasmProvider } from './useWasm';

const App = () => {
   return (
      <WasmProvider src='wasm_bg.wasm'>
         <ComponentWithWasm />
      </WasmProvider>
   );
};

export default App;
```

```tsx: ComponentWithWasm.tsx
import React from 'react';
import useWasm, { WasmLoadState } from './useWasm';

const ComponentWithWasm = () => {
   const wasm = useWasm();

   return (
      <div>
         {wasm.loadState === WasmLoadState.Loading && (
            <p>Loading...</p>
         )}
         {wasm.loadState === WasmLoadState.Error && (
            <p>Error: {wasm.error.message}</p>
         )}
         {wasm.loadState === WasmLoadState.Ready && (
            <p>1 + 2 = {wasm.exports.add(1, 2)}</p>
         )}
      </div>
   );
};

export default ComponentWithWasm;
```

# æœ€å¾Œã«

wasmbuild ã®ç”Ÿæˆç‰©ã‚’ä½¿ç”¨ã™ã‚‹ Custom Hooks ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸãŸã‚ä½œæˆã—ãŸ. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘è¡¨ç¤ºã™ã‚Œã°, ä»–ã¯é€šå¸¸ã®é–¢æ•°ã¨åŒæ§˜ã«æ‰±ãˆã‚‹ãŸã‚, éå¸¸ã«ä¾¿åˆ©ã§ã‚ã‚‹.

# å‚è€ƒæ–‡çŒ®

- [Up and Running with React + Rust + Wasm](https://prestonrichey.com/blog/react-rust-wasm/)
- [use-wasm-ts](https://github.com/Romainlg29/use-wasm)
- [React-WASM-boilerplate](https://github.com/robtaussig/React-WASM-boilerplate)
